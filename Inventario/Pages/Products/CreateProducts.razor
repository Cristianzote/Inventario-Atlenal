@page "/product/create"
@inject NavigationManager navigationManager

@using Access.API;
@using System.Text.Json;
@using System.Text.Json.Serialization;
@using System.Net.Http;
@using System.Net.Http.Json;

<div class="pb-24 pt-8 bg-green-800">
    <div class="w-5/6 mx-auto bg-white p-6 rounded-lg shadow-md ring-2 ring-green-700">
        <h1 class="text-lg font-medium text-green-900 mb-4">Crear producto</h1>

        <!-- Product Name -->
        <div class="mb-6">
            <label for="name" class="block text-sm font-medium text-green-900 mb-1">Nombre del producto</label>
            <input @bind="product.name" type="text" id="name" name="name" class="w-full py-2 px-3 bg-gray-100 text-green-900 border border-green-300 rounded-md focus:outline-none focus:ring focus:ring-green-500">
        </div>

        <!-- Product Category (Select Dropdown) -->
        <div class="mb-6">
            <label for="category" class="block text-sm font-medium text-green-900 mb-1">Categoría</label>
            <select @bind="@product.category" id="category" name="category" class="w-full py-2 px-3 bg-gray-100 text-green-900 border border-green-300 rounded-md focus:outline-none focus:ring focus:ring-green-500">
                <option value="@((int)CategoryType.ALL)">Todos</option>
                <option value="@((int)CategoryType.SODA)">Gaseosa</option>
                <option value="@((int)CategoryType.ALCOHOLIC)">Trago</option>
                <option value="@((int)CategoryType.DRINK)">Trago</option>
                <option value="@((int)CategoryType.SNACK)">Mekato</option>
            </select>
        </div>

        @for (int i = 0; i < presentationArray.Count(); i++)
        {
            var index = i;
            <label for="presentationName" class="block text-sm font-medium text-green-900 mb-1"></label>

            <div class="mb-6 border-b border-green-300 pb-4">

                <div class="w-full flex justify-between">
                    <h2 class="text-lg font-medium text-green-900 mb-4">Presentación @(index + 1)</h2>
                    <div class="flex justify-center">
                        <button @onclick="() => DeletePresentation(index)" type="submit" class="bg-red-400 inline-block bg-fuchsia-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-md focus:outline-none focus:ring focus:ring-red-200 transition duration-300">Eliminar</button>
                    </div>
                </div>

                <!-- Name of Presentation -->
                <div class="mb-4">
                    <label for="presentationName" class="block text-sm font-medium text-green-900 mb-1">Nombre de la presentación</label>
                    <input type="text" id="presentationName" name="name" @bind="presentationArray[index].name" class="w-full py-2 px-3 bg-gray-100 text-green-900 border border-green-300 rounded-md focus:outline-none focus:ring focus:ring-green-500">
                </div>

                <!-- Income Price and Outcome Price (Combined) -->
                <div class="flex justify-between mb-4">
                    <div class="w-1/2 pr-2">
                        <label for="incomePrice" class="block text-sm font-medium text-green-900 mb-1">Precio de entrada</label>
                        <input type="number" id="incomePrice" name="incomePrice" @bind="@presentationArray[index].priceIncome" class="w-full py-2 px-3 bg-gray-100 text-green-900 border border-green-300 rounded-md focus:outline-none focus:ring focus:ring-green-500">
                    </div>
                    <div class="w-1/2 pl-2">
                        <label for="outcomePrice" class="block text-sm font-medium text-green-900 mb-1">Precio de salida</label>
                        <input type="number" id="outcomePrice" name="outcomePrice" @bind="@presentationArray[index].priceOutput" class="w-full py-2 px-3 bg-gray-100 text-green-900 border border-green-300 rounded-md focus:outline-none focus:ring focus:ring-green-500">
                    </div>
                </div>

                <!-- Detail Sale Switch -->
                <div>
                    <div class="flex items-center mb-4">
                        <input @bind="@detailCheckbox[index]" id="@($"detailSale{i}")" name="@($"detailSale{index}")" type="checkbox" class="h-4 w-4 bg-gray-100 text-green-900 focus:ring focus:ring-green-500 border border-green-300 rounded mr-2">

                    <label for="@($"detailSale{i}")" class="text-sm font-medium text-green-900">¿Presentación con venta menudeada?</label>
                    </div>

                   @if (detailCheckbox[i] == true)
                   {
                        <!-- Detail Count Input (Shown if Detail Sale Switch is checked) -->
                        <div class="flex items-center">
                            <label for="detailCount" class="text-sm font-medium text-green-900">Descartar una unidad cada </label>
                            <input type="number" id="detailCount" name="detailCount" @bind="@presentationArray[index].retailStockRatio" class="mx-2 w-16 py-2 px-3 bg-gray-100 text-green-900 border border-green-300 rounded-md focus:outline-none focus:ring focus:ring-green-500 ml-2">
                            <label for="detailCount" class="text-sm font-medium text-green-900"> ventas menudeadas</label>
                        </div>
                   }
                </div>
            </div>
        }

        <!-- Plus Button (to add more presentations) -->
        <div class="flex justify-center mb-6">
            <button @onclick="AddPresentation" type="button" class="bg-green-400 inline-block bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-full focus:outline-none focus:ring focus:ring-green-200 transition duration-300">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                </svg>
            </button>
        </div>

        <!-- Submit and Cancel Buttons -->
        <div class="flex justify-end">
            <button @onclick="()=>CreateProduct(presentationArray, detailCheckbox)" type="submit" class="bg-green-400 inline-block bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-md focus:outline-none focus:ring focus:ring-green-200 transition duration-300 mr-4">Crear</button>
            <button @onclick="CancelCreation" type="button" class="bg-red-400 inline-block bg-fuchsia-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-md focus:outline-none focus:ring focus:ring-red-200 transition duration-300">Cancelar</button>
        </div>
    </div>
</div>


@code {

    Product product = new Product {};
    Presentation[] presentationArray = [];
    bool[] detailCheckbox = [];

    protected void AddPresentation()
    {
        Presentation NewPresentation = new Presentation
            {
                priceIncome = 1,
                priceOutput = 1,
                retailStockRatio = 1,
                priceRetail = 1,
                description = string.Empty
            };
        Array.Resize(ref presentationArray, presentationArray.Length + 1);
        presentationArray[presentationArray.Length - 1] = NewPresentation;

        ResizeCheckboxArray(presentationArray);
    }

    protected void ToggleDetail(int i)
    {
        if (i >= 0 && i < detailCheckbox.Length)
        {
            detailCheckbox[i] = !detailCheckbox[i];
        }
    }


    protected void ResizeCheckboxArray(Presentation[] presentations)
    {
        Array.Resize(ref detailCheckbox, presentations.Length);
        for (int i = 0; i < detailCheckbox.Length; i++)
        {
            detailCheckbox[i] = presentations[i].retailStockRatio != 1 && presentations[i].retailStockRatio != 0;
        }
    }

    protected void DeletePresentation(int Id)
    {
        if (Id >= 0 && Id < presentationArray.Length)
        {
            var presentationsList = presentationArray.ToList();
            presentationsList.RemoveAt(Id);
            presentationArray = presentationsList.ToArray();

            ResizeCheckboxArray(presentationArray);
        }
    }

    private async Task CreateProduct(Presentation[] presentationArray, bool[] detailCheckbox)
    {
        var options = new JsonSerializerOptions
            {
                ReferenceHandler = ReferenceHandler.Preserve,
                WriteIndented = true
            };

        try
        {
            // Build transaction body
            product.presentations = presentationArray.ToList();
            product.description = string.Empty;
            product.image = string.Empty;

            // Serialize the transaction object to JSON
            var jsonTransaction = JsonSerializer.Serialize(product, options);

            // Debug: Print the JSON to ensure it's correct
            Console.WriteLine(jsonTransaction);

            var content = new StringContent(jsonTransaction, System.Text.Encoding.UTF8, "application/json");

            // Make petition
            HttpClient client = new HttpClient();
            HttpResponseMessage response = await client.PostAsJsonAsync($"http://www.baratlenal.somee.com/api/v1/product", product);

            // Optionally read the response content
            string responseBody = await response.Content.ReadAsStringAsync();
            Console.WriteLine(responseBody);

            if (!response.IsSuccessStatusCode)
            {
                throw new Exception($"Server error (HTTP {response.StatusCode}): {responseBody}");
            }
            //If the transaction is succesful
            navigationManager.NavigateTo("/product");
        }
        catch (Exception e)
        {
            Console.WriteLine($"Request error: {e.Message}");
        }
    }

    protected void CancelCreation()
    {
        navigationManager.NavigateTo("/product");
    }
}
